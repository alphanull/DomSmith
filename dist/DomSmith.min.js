/*!
* DomSmith – Javascript Dom library
* @license MIT
* © 2016–present Frank Kudermann @ alphanull
*/
function e(e=document.createElement("div")){const t=[];for(const o in e)o.startsWith("on")&&t.push(o.slice(2));return t.sort()}const t=[],o=["ref","tag","nodes","text","events"],n=["_dom","_refs","_parent","_events","constructor","prototype","addNode","replaceNode","removeNode","addEvent","removeEvent","destroy","teardown"],r=e();let i=!1;class s{constructor(e,o){i||(i=!0,t.sort(((e,t)=>t.priority-e.priority))),this._mountContext={},o instanceof HTMLElement?this._mountContext={ele:o,insertMode:"append"}:o&&"object"==typeof o&&o.ele&&(this._mountContext={ele:o.ele,insertMode:o.insertMode||"append"});const n=this._mountContext.ele?{_ele:this._mountContext.insertMode&&"append"!==this._mountContext.insertMode&&"top"!==this._mountContext.insertMode?this._mountContext.ele.parentNode:this._mountContext.ele,_nodes:[]}:null;this._refs=new WeakMap,this._events=new WeakMap,this._dom=this.addNode(e,n),this._mountContext.parent=n&&n._ele,n&&Array.isArray(this._dom)&&(n._nodes=this._dom),this._mountContext.ele&&this.mount()}mount(e){if(this._mountContext.mounted)return;e&&(e instanceof HTMLElement?this._mountContext={ele:e,insertMode:"append"}:"object"==typeof e&&e.ele&&(this._mountContext={ele:e.ele,insertMode:e.insertMode||"append"}),this._mountContext.parent="append"===this._mountContext.insertMode||"top"===this._mountContext.insertMode?this._mountContext.ele:this._mountContext.ele.parentNode);const{ele:o,insertMode:n,parent:r,nextSibling:i}=this._mountContext;if(!o||!r)throw new Error("[DomSmith] Invalid insertMode ele.");if(Array.isArray(this._dom)){const e=document.createDocumentFragment();let t=!1;if(this._dom.forEach((o=>{o._ele.parentNode||(e.appendChild(o._ele),t=!0)})),!t)return;"top"===n?r.insertBefore(e,r.firstChild):"before"===n?r.insertBefore(e,o):"replace"===n?(r.insertBefore(e,o),r.contains(o)&&r.removeChild(o)):i&&i.parentNode===r?r.insertBefore(e,i):r.appendChild(e)}else{const e=this._dom._ele;if(e.parentNode)return;"top"===n?r.insertBefore(e,r.firstChild):"before"===n?r.insertBefore(e,o):"replace"===n?r.replaceChild(e,o):i&&i.parentNode===r?r.insertBefore(e,i):r.appendChild(e)}t.forEach((({plugin:e})=>{"function"==typeof e.mount&&e.mount(this._dom,this._mountContext)})),this._mountContext.mounted=!0}unmount(){if(this._mountContext.mounted){if(t.forEach((({plugin:e})=>{"function"==typeof e.unmount&&e.unmount(this._dom,this._mountContext)})),Array.isArray(this._dom)){const e=this._dom.filter((e=>e._ele&&e._ele.parentNode));if(e.length>0){const t=e[0]._ele.parentNode,o=Array.from(t.childNodes),n=o.indexOf(e[e.length-1]._ele),r=o[n+1]||null;this._mountContext.parent=t,this._mountContext.nextSibling=r}e.forEach((e=>e._ele.remove()))}else if(this._dom&&this._dom._ele&&this._dom._ele.parentNode){const e=this._dom._ele;this._mountContext.parent=e.parentNode,this._mountContext.nextSibling=e.nextSibling,e.remove()}this._mountContext.mounted=!1}}addNode(i,s){let d="string"==typeof i||Array.isArray(i)?i:{...i};if(Array.isArray(d)){return d.map((e=>{const t=this.addNode(e,s);return s&&Array.isArray(s._nodes)&&s._nodes.push(t),t}))}function h(e){if(void 0!==e._text)return document.createTextNode(e._text);const t="http://www.w3.org/2000/svg";return!(s&&s._ele&&"foreignobject"===s._ele.tagName.toLowerCase())&&(e._tag&&"svg"===e._tag.toLowerCase()||s&&s._ele&&s._ele.namespaceURI===t)?document.createElementNS(t,e._tag):document.createElement(e._tag||"div")}"string"!=typeof d&&o.forEach((e=>{e in d&&!(`_${e}`in d)&&(d[`_${e}`]=d[e],delete d[e],console.warn(`[DomSmith] Deprecated nodeDef key "${e}" – use "_${e}" instead.`))})),("string"==typeof d||d instanceof String)&&(d={_text:d}),d._ele=h(d),t.forEach((({plugin:e})=>{"function"==typeof e.addNode&&(d=e.addNode(d)||d)})),d._ele||(d._ele=h(d));const{_nodes:a,_tag:l,_ref:_,_events:m,_ele:u}=d;if(Object.entries(d).forEach((([t,o])=>{if(t.startsWith("_")||t.startsWith("$")||null==o)return;if(("video"===l||"audio"===l?e(u):r).includes(t))this.addEvent(u,t,o);else if(t.includes("."))!function(e,t,o){const n=t.split("."),r=n.slice(0,-1).reduce(((e,t)=>void 0===e||void 0===e[t]?null:e[t]),e);if("object"!=typeof r||null===r)throw new Error(`[DomSmith] Did not find property with path: ${t}`);r[n.pop()]=o}(u,t,o);else if(t in u)try{u[t]=o}catch(e){u.setAttribute(t,o)}else u.setAttribute(t,o)})),m&&Object.entries(m).forEach((([e,t])=>{this.addEvent(u,e,t)})),s&&(d._parent=s),_){if(n.includes(_))throw new Error("[DomSmith] Reserved properties are not allowed as ref");if(this[_])throw new Error("[DomSmith] No Duplicate Refs are allowed");this[_]=u,this._refs.set(u,d)}return a&&("string"==typeof a&&(d._nodes=[a]),d._nodes=d._nodes.reduce(((e,t)=>{if(t){const o=this.addNode(t,d);u.appendChild(o._ele),e.push(o)}return e}),[])),d}replaceNode(e,t){const o=this[e];let n=this._refs.get(o);if(!n)throw new Error("[DomSmith] invalid ref used with replaceNode");n=this.removeNode(n);const r=n._parent._nodes.findIndex((e=>e===n)),i=this.addNode(t,n._parent);i._parent._ele.replaceChild(i._ele,n._ele),i._parent._nodes[r]=i}removeNode(e=this._dom){let o=e;return t.forEach((({plugin:e})=>{"function"==typeof e.removeNode&&(o=e.removeNode(o)||o)})),Array.isArray(o)?(o.forEach((e=>this.removeNode(e))),o):(this.removeEvent(o._ele),o._events&&delete o._events,o._ref&&(this._refs.delete(this[o._ref]),delete this[o._ref]),o._nodes&&o._nodes.forEach((e=>this.removeNode(e))),o)}addEvent(e,t,o){if(!o)return;const n="string"==typeof e?this[e]:e;if(!n)throw new Error(`[DomSmith] removeEvent: ele or ref: ${e} not found`);this._events.has(n)||this._events.set(n,{});const r=this._events.get(n);if(r[t]||(r[t]=[]),Array.isArray(o))o.forEach((e=>{if("function"!=typeof e)throw new Error("[DomSmith] Handler must be a function");n.addEventListener(t,e),r[t].push(e)}));else{if("function"!=typeof o)throw new Error("[DomSmith] Handler must be a function");n.addEventListener(t,o),r[t].push(o)}}removeEvent(e,t,o){const n="string"==typeof e?this[e]:e;if(!n)throw new Error(`[DomSmith] removeEvent: ele or ref: ${e} not found`);if(!this._events.has(n))return;const r=this._events.get(n);if(t){if(!r[t])return;o?(n.removeEventListener(t,o),r[t]=r[t].filter((e=>e!==o))):(r[t].forEach((e=>n.removeEventListener(t,e))),delete r[t]),0===Object.keys(r).length&&this._events.delete(n)}else Object.keys(r).forEach((e=>{r[e].forEach((t=>n.removeEventListener(e,t)))})),this._events.delete(n)}teardown(){console.warn("[DomSmith] teardown() is deprecated, use destroy() instead."),this.destroy()}destroy(){t.forEach((e=>{e.destroy&&e.destroy()})),this.removeNode(),this.unmount(),this._mountContext&&(this._mountContext.ele=null,this._mountContext.parent=null,this._mountContext.nextSibling=null),this._dom=this._refs=this._mountContext=this._events=null}static registerPlugin(e,{priority:o=0}={}){t.some((t=>t.plugin===e))||t.push({plugin:e,priority:o})}}export{s as default};
